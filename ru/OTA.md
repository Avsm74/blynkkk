# Обновление "по воздуху" (OTA)

Blynk также поддерживает беспроводное обновления для плат ESP8266, NodeMCU и SparkFun Blynk. На данный момент ОТА поддерживается только для частных серверов и для платных клиентов.

## Как это работает?

 - Вам нужно использовать [обычный скетч для экспортируемых приложений](https://github.com/blynkkk/blynk-library/tree/master/examples/Blynk.Inject/Template_ESP8266);
 - После того, как вы запустили свое оборудование, все готово к обвнолению "по воздуху";
 - Вы можете запустить обновление прошивки для конкретного оборудования через его токен или для всего оборудования в сети.
 
### Заливка прошивки
  
1. Пользователь запускает OTA одним из нижеуказанных HTTPS-запросов;
2. Пользователь предоставляет в HTTPS-запросе учетные данные администратора и двоичный файл прошивки для обновления оборудования;
3. Когда оборудование подключается к серверу - сервер проверяет его прошивку. В случае, если дата сборки аппаратной прошивки старше загруженной прошивки, сервер отправляет на аппаратное обеспечение специальную команду с URL для новой прошивки;
4. Оборудование обработает указанный URL-адрес таким [обработчиком](https://github.com/blynkkk/blynk-library/blob/master/examples/Blynk.Inject/Template_ESP8266/OTA.h#L31):
 
    ```
      BLYNK_WRITE(InternalPinOTA) {
        //URL адрес с прошивкой. Возможен только HTTP адрес
        //http://localhost:8080/static/ota/FUp_2441873656843727242_upload.bin
        overTheAirURL = param.asString();
        ...
      }
    ```

5. Обрудование самостоятельно загружает новую прошивку и начинает обновление;

## Выборочное обновление для конкретного оборудования

```
curl -v -F file=@Template_ESP8266.ino.nodemcu.bin --insecure -u admin@blynk.cc:admin https://localhost:9443/admin/ota/start?token=123
```

 - ```Template_ESP8266.ino.nodemcu.bin``` - относительный (или полный) путь к вашей прошивке;
 - ```--insecure``` флаг для серверов с самостоятельно созданными сертификатами. Вам не нужен этот флаг, если вы использовали Let's Encrypt или другие доверенные сертификаты;
 - ```admin@blynk.cc:admin``` учетные данные администратора на вашем сервере. Указаны значения по умлочанию. Формат: ```username:password```. Вы можете изменить имя пользователя и пароль в файле ```server.properties```;
 - ```token``` ключь является признаком вашего оборудования, к которому вы хотите применить обновление прошивки. Обновление прошивки будет начато только в том случае, если устройство подключено к сети;

## Обновление "по воздуху" для всех устройств
 
Обновление для всех устройств будет запускаться только тогда, когда они подключены к облаку. Для этого вам нужно удалить часть с токен ключом.

```
curl -v -F file=@Template_ESP8266.ino.nodemcu.bin --insecure -u admin@blynk.cc:admin https://localhost:9443/admin/ota/start
```

В этом случае OTA будет срабатывать сразу после подключения устройства к серверу. Если устройство подключено к сети, обновление встроенного ПО будет начато только после повторного подключения устройства.

## Обновление "по воздуху" от конкретного пользователя

В этом случае обновление прошивки будет срабатывать для всех устройств, указанных пользователем.

```
curl -v -F file=@Template_ESP8266.ino.nodemcu.bin --insecure -u admin@blynk.cc:admin https://localhost:9443/admin/ota/start?user=pupkin@gmail.com
```

## Обновление "по воздуху" для конкретного пользователя и проекта

В этом случае обновление прошивки будет срабатывать для всех устройств указанного пользователя в указанном проекте.

```
curl -v -F file=@Template_ESP8266.ino.nodemcu.bin --insecure -u admin@blynk.cc:admin https://localhost:9443/admin/ota/start?user=pupkin@gmail.com&project=123
```

## Остановка OTA

```
curl -v --insecure -u admin@blynk.cc:admin https://localhost:9443/admin/ota/stop
```

## Как сделать бинарную прошивку 

Чтобы сделать прошивку в Arduino IDE - зайдите в меню: Скетч -> Экспорт бинарного файла.

**ПРИМЕЧАНИЕ:** ESP8266 принимает прошивку только по протоколу HTTP, а не HTTPS.
